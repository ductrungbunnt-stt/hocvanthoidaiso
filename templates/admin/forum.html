{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω di·ªÖn ƒë√†n - VƒÉn h·ªçc th·ªùi ƒë·∫°i s·ªë{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-user-shield me-2"></i>Qu·∫£n tr·ªã h·ªá th·ªëng
                    </h5>
                    <div class="list-group list-group-flush">
                        <a href="/admin" class="list-group-item list-group-item-action">
                            <i class="fas fa-tachometer-alt me-2"></i> T·ªïng quan
                        </a>
                        <a href="/admin/forum" class="list-group-item list-group-item-action active">
                            <i class="fas fa-comments me-2"></i> Qu·∫£n l√Ω di·ªÖn ƒë√†n
                        </a>
                        <a href="/admin/users" class="list-group-item list-group-item-action">
                            <i class="fas fa-users me-2"></i> Qu·∫£n l√Ω ng∆∞·ªùi d√πng
                        </a>
                        <a href="/admin/reportPost" class="list-group-item list-group-item-action">
                            <i class="fas fa-robot me-2"></i> Qu·∫£n l√Ω b√°o c√°o b√†i vi·∫øt
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9">
            <!-- Th·ªëng k√™ di·ªÖn ƒë√†n -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-gradient-primary text-white shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-0">T·ªïng s·ªë b√†i vi·∫øt</h6>
                                    <h2 class="mt-2 mb-0" id="total-posts">0</h2>
                                </div>
                                <div class="icon-box">
                                    <i class="fas fa-file-alt fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
               
                
            </div>

            <!-- Danh s√°ch b√†i vi·∫øt -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>Danh s√°ch b√†i vi·∫øt
                        </h5>
                        <div class="d-flex gap-2">
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" placeholder="T√¨m ki·∫øm...">
                            </div>
                            <select class="form-select" id="statusFilter" style="width: auto;">
                                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                <option value="active">Ho·∫°t ƒë·ªông</option>
                                <option value="hidden">ƒê√£ ·∫©n</option>
                                <option value="deleted">ƒê√£ x√≥a</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
    <thead>
        <tr>
            <th>·∫¢nh</th>
            <th>N·ªôi dung</th>
            <th>T√°c gi·∫£</th>
            <th>L∆∞·ª£t th√≠ch</th>
            <th>S·ªë b√¨nh lu·∫≠n</th>
            <th>Ng√†y ƒëƒÉng</th>
            <th>Ng√†y c·∫≠p nh·∫≠t</th>
            <th>Thao t√°c</th>
        </tr>
    </thead>
    <tbody id="postsTableBody">
        <!-- Recent posts will be loaded here -->
    </tbody>
</table>
                    </div>

                    <!-- Ph√¢n trang -->
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Pagination will be loaded here -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal xem chi ti·∫øt b√†i vi·∫øt -->
<div class="modal fade" id="viewPostModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Chi ti·∫øt b√†i vi·∫øt
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="postDetails">
                    <!-- Post details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-danger" onclick="deletePost()">X√≥a</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Viewing Post -->
<div id="postModal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi ti·∫øt b√†i vi·∫øt</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closePostModal()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>N·ªôi dung:</strong> <span id="postContent"></span></p>
                <p><strong>Ng∆∞·ªùi ƒëƒÉng:</strong> <span id="postAuthor"></span></p>
                <p><strong>Ng√†y ƒëƒÉng:</strong> <span id="postDate"></span></p>
                <p><strong>L∆∞·ª£t th√≠ch:</strong> <span id="postLikes"></span></p>
                <img id="postImage" src="" alt="" style="max-width: 100%; border-radius: 5px; margin-bottom: 10px;">
                <h5>B√¨nh lu·∫≠n:</h5>
                <ul id="postComments" style="list-style: none; padding: 0; max-height: 200px; overflow-y: auto;"></ul>
                <!-- <ul id="postComments" style="list-style: none; padding: 0;"></ul> -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePostModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ch·ªânh S·ª≠a B√†i Vi·∫øt -->
<div class="modal fade" id="editPostModal" tabindex="-1" aria-labelledby="editPostModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPostModalLabel">Ch·ªânh s·ª≠a b√†i vi·∫øt</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="editTitle" class="form-label">Ti√™u ƒë·ªÅ</label>
          <input type="text" class="form-control" id="editTitle" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt">
        </div>
        <div class="mb-3">
          <label for="editContent" class="form-label">N·ªôi dung</label>
          <textarea class="form-control" id="editContent" rows="5" placeholder="Nh·∫≠p n·ªôi dung b√†i vi·∫øt"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        <button type="button" class="btn btn-primary" id="saveEditedPost">L∆∞u thay ƒë·ªïi</button>
      </div>
    </div>
  </div>
</div>


<style>
/* Gradient backgrounds */
.bg-gradient-primary {
    background: linear-gradient(45deg, #4e73df, #224abe);
}

.bg-gradient-success {
    background: linear-gradient(45deg, #1cc88a, #169b6b);
}

.bg-gradient-info {
    background: linear-gradient(45deg, #36b9cc, #258391);
}

.bg-gradient-warning {
    background: linear-gradient(45deg, #f6c23e, #dda20a);
}

/* Icon box */
.icon-box {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
}

/* Card styles */
.card {
    border: none;
    border-radius: 10px;
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-5px);
}

/* Table styles */
.table {
    margin-bottom: 0;
}

.table th {
    border-top: none;
    background-color: #f8f9fc;
    font-weight: 600;
    color: #4e73df;
}

.table td {
    vertical-align: middle;
}

/* Button styles */
.btn {
    border-radius: 5px;
    padding: 0.375rem 0.75rem;
    font-weight: 500;
}

.btn-primary {
    background-color: #4e73df;
    border-color: #4e73df;
}

.btn-primary:hover {
    background-color: #224abe;
    border-color: #224abe;
}

/* List group styles */
.list-group-item {
    border: none;
    padding: 0.75rem 1.25rem;
    margin-bottom: 0.25rem;
    border-radius: 5px;
    transition: all 0.2s;
}

.list-group-item:hover {
    background-color: #f8f9fc;
}

.list-group-item.active {
    background-color: #4e73df;
    border-color: #4e73df;
}

/* Pagination styles */
.pagination {
    margin-bottom: 0;
}

.page-link {
    color: #4e73df;
    border: none;
    padding: 0.5rem 1rem;
    margin: 0 0.25rem;
    border-radius: 5px;
}

.page-item.active .page-link {
    background-color: #4e73df;
    border-color: #4e73df;
}

/* Animation */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.card {
    animation: fadeIn 0.5s ease-out;
}

.modal {
    display: none; /* Hidden by default */
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
    /* display: flex; */
    justify-content: center; /* Center horizontally */
    align-items: center; /* Center vertically */
}

.modal-dialog {
    max-width: 500px;
    width: 100%;
    background-color: #fff;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
let currentPage = 1;
const itemsPerPage = 10;
let totalPages = 1;
let currentPostId = null;

const API_URL = '/api/admin/forum/posts';
const token = localStorage.getItem('token');
const headers = {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
};

// Ki·ªÉm tra quy·ªÅn admin

document.addEventListener('DOMContentLoaded', function () {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user || user.level !== 'admin') {
        window.location.href = '/login';  // ƒê√¢y l√† ch·ªó c√≥ th·ªÉ ƒëang redirect sai
    }
	// Load th·ªëng k√™ v√† danh s√°ch b√†i vi·∫øt
    loadStatistics();
    loadPosts();
});


async function loadStatistics() {
    const token = localStorage.getItem("token");

    if (!token) {
        alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");
        window.location.href = "/login";
        return;
    }

    console.log("Token:", token); // Ki·ªÉm tra token trong console

    try {
        const response = await fetch("http://127.0.0.1:8000/api/admin/forum/statistics", {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            }
        });

        if (!response.ok) {
            // ƒê·ªçc text l·ªói t·ª´ server ƒë·ªÉ debug th√™m
            const errorText = await response.text();
            throw new Error(`L·ªói: ${response.status} - ${errorText}`);
        }

        const stats = await response.json();
        console.log("üìä Th·ªëng k√™ di·ªÖn ƒë√†n:", stats);

        document.getElementById("total-posts").innerText = stats.total_posts ?? 0;
        // C·∫≠p nh·∫≠t c√°c s·ªë li·ªáu kh√°c n·∫øu c·∫ßn...
    } catch (error) {
        console.error("‚ùå L·ªói khi t·∫£i th·ªëng k√™:", error);
        alert("Kh√¥ng th·ªÉ t·∫£i th·ªëng k√™ di·ªÖn ƒë√†n!");
    }
}

async function loadStatistics() {
    const token = localStorage.getItem("token");

    if (!token) {
        alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");
        window.location.href = "/login";
        return;
    }

    try {
        const response = await fetch("http://127.0.0.1:8000/api/admin/forum/statistics", {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            }
        });

        if (!response.ok) {
            throw new Error("L·ªói: " + response.statusText);
        }

        const stats = await response.json();
        console.log("üìä T·ªïng s·ªë b√†i vi·∫øt:", stats.total_posts);

        // C·∫≠p nh·∫≠t s·ªë b√†i vi·∫øt l√™n giao di·ªán
        const postElement = document.getElementById("total-posts");
        if (postElement) postElement.innerText = stats.total_posts ?? 0;

    } catch (error) {
        console.error("‚ùå L·ªói khi t·∫£i th·ªëng k√™:", error);
        alert("Kh√¥ng th·ªÉ t·∫£i th·ªëng k√™ di·ªÖn ƒë√†n!");
    }
}

// C·∫≠p nh·∫≠t ph√¢n trang
function updatePagination(currentPage) {
    const pagination = document.getElementById('pagination');
    if (!pagination) return;
    pagination.innerHTML = '';

    // N√∫t Previous
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `
        <a class="page-link" href="#" onclick="loadPosts(${currentPage - 1})">
            <i class="fas fa-chevron-left"></i>
        </a>
    `;
    pagination.appendChild(prevLi);

    // C√°c n√∫t s·ªë trang
    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `
            <a class="page-link" href="#" onclick="loadPosts(${i})">${i}</a>
        `;
        pagination.appendChild(li);
    }

    // N√∫t Next
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `
        <a class="page-link" href="#" onclick="loadPosts(${currentPage + 1})">
            <i class="fas fa-chevron-right"></i>
        </a>
    `;
    pagination.appendChild(nextLi);
}
// Load danh s√°ch b√†i vi·∫øt theo trang
async function loadPosts(page = 1) {
    try {
        const searchQuery = document.getElementById('searchInput')?.value || '';
        const statusFilter = document.getElementById('statusFilter')?.value || '';
        const token = localStorage.getItem('token');
        
        if (!token) {
            alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y.');
            return;
        }

        const response = await fetch(`/api/admin/forum/posts?page=${page}&search=${searchQuery}&status=${statusFilter}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch b√†i vi·∫øt');
        
        const data = await response.json();
        const container = document.getElementById('postsTableBody');
        if (!container) return;
        container.innerHTML = '';
        
        if (data.posts.length > 0) {
            data.posts.forEach(post => {
                const createdAt = post.created_at ? new Date(post.created_at).toLocaleDateString() : "Kh√¥ng r√µ";
                const updatedAt = post.updated_at ? new Date(post.updated_at).toLocaleDateString() : "Ch∆∞a c·∫≠p nh·∫≠t";
                const commentsCount = post.comments.length;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${post.media_url}" alt="Media" class="post-media" width="50" /></td>
                    <td>${post.content}</td>
                    <td><img src="${post.user.avatar}" alt="${post.user.name}" class="avatar-img" width="30" /> ${post.user.name}</td>
                    <td>${post.likes}</td>
                    <td>${commentsCount}</td>
                    <td>${createdAt}</td>
                    <td>${updatedAt}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1"  onclick="viewPost('${post._id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletePost('${post._id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                container.appendChild(row);
            });
            totalPages = Math.ceil(data.total / itemsPerPage);
            updatePagination(page);
        } else {
            container.innerHTML = '<tr><td colspan="8" class="text-center">Kh√¥ng c√≥ b√†i vi·∫øt n√†o</td></tr>';
        }
    } catch (error) {
        console.error(error);
        document.getElementById('postsTableBody').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Kh√¥ng th·ªÉ t·∫£i danh s√°ch b√†i vi·∫øt</td></tr>';
    }
}


// Ch·ªânh s·ª≠a b√†i vi·∫øt
async function editPost(postId) {
    try {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y.');
            return;
        }

        const response = await fetch(`/api/admin/forum/posts/${postId}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i b√†i vi·∫øt');
        
        const data = await response.json();
        const editTitle = document.getElementById('editTitle');
        const editContent = document.getElementById('editContent');
        
        if (!editTitle || !editContent) return;
        
        editTitle.value = data.post.title || '';
        editContent.value = data.post.content || '';
        currentPostId = postId;
        
        const modalElement = document.getElementById('editPostModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    } catch (error) {
        console.error(error);
        alert('Kh√¥ng th·ªÉ t·∫£i b√†i vi·∫øt');
    }
}

// X√≥a b√†i vi·∫øt
async function deletePost(postId) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y?')) return;
    try {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y.');
            return;
        }

        const response = await fetch(`/api/admin/forum/posts/${postId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ x√≥a b√†i vi·∫øt');
        
        loadPosts(currentPage);
        alert('X√≥a b√†i vi·∫øt th√†nh c√¥ng');
    } catch (error) {
        console.error(error);
        alert('L·ªói khi x√≥a b√†i vi·∫øt');
    }
}


function viewPost(postId) {
    // Fetch post details from the server
    fetch(`/forum/posts/${postId}`)
        .then(response => response.json())
        .then(data => {
            if (data) {
                // Populate the modal with post details
                document.getElementById('postContent').innerText = data.content;
                document.getElementById('postAuthor').innerText = data.user.name;
                document.getElementById('postDate').innerText = new Date(data.created_at).toLocaleDateString();
                document.getElementById('postLikes').innerText = data.likes;
                document.getElementById('postImage').src = data.media_url.startsWith('/') ? `http://localhost:8000${data.media_url}` : data.media_url;

                // Populate the comments
                const commentsContainer = document.getElementById('postComments');
                commentsContainer.innerHTML = '';
                if (data.comments && data.comments.length > 0) {
                    data.comments.forEach(comment => {
                        const commentItem = document.createElement('li');
                        commentItem.style.borderBottom = '1px solid #ddd';
                        commentItem.style.padding = '5px 0';
                        commentItem.innerHTML = `
                            <p><strong>${comment.author}</strong>: ${comment.content}</p>
                            <p style="font-size: 0.9em; color: gray;">Ng√†y: ${new Date(comment.created_at).toLocaleDateString()}</p>
                        `;
                        commentsContainer.appendChild(commentItem);
                    });
                } else {
                    commentsContainer.innerHTML = '<li>Kh√¥ng c√≥ b√¨nh lu·∫≠n n√†o</li>';
                }

                // Show the modal
                document.getElementById('postModal').style.display = 'flex';
            } else {
                alert('Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt b√†i vi·∫øt');
            }
        })
        .catch(error => {
            console.error('L·ªói khi t·∫£i chi ti·∫øt b√†i vi·∫øt:', error);
            alert('Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt b√†i vi·∫øt');
        });
}

function closePostModal() {
    document.getElementById('postModal').style.display = 'none';
}

// X√≥a b√¨nh lu·∫≠n
async function deleteComment(commentId) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/forum/comments/${commentId}`, {
            method: 'DELETE',
            headers: {
                'X-Username': localStorage.getItem('username')
            }
        });
        
        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ x√≥a b√¨nh lu·∫≠n');
        }
        
        // Reload th√¥ng tin b√†i vi·∫øt
        viewPost(currentPostId);
        
        alert('X√≥a b√¨nh lu·∫≠n th√†nh c√¥ng');
        
    } catch (error) {
        console.error('L·ªói khi x√≥a b√¨nh lu·∫≠n:', error);
        alert('Kh√¥ng th·ªÉ x√≥a b√¨nh lu·∫≠n');
    }
}

// L·ªçc v√† t√¨m ki·∫øm
document.getElementById('searchInput').addEventListener('input', debounce(function() {
    currentPage = 1;
    loadPosts(currentPage);
}, 500));

document.getElementById('statusFilter').addEventListener('change', function() {
    currentPage = 1;
    loadPosts(currentPage);
});

// H√†m debounce ƒë·ªÉ tr√°nh g·ªçi API qu√° nhi·ªÅu
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// H√†m h·ªó tr·ª£
function getStatusColor(status) {
    switch (status) {
        case 'active':
            return 'success';
        case 'hidden':
            return 'warning';
        case 'deleted':
            return 'danger';
        default:
            return 'secondary';
    }
}

function getStatusText(status) {
    switch (status) {
        case 'active':
            return 'Ho·∫°t ƒë·ªông';
        case 'hidden':
            return 'ƒê√£ ·∫©n';
        case 'deleted':
            return 'ƒê√£ x√≥a';
        default:
            return 'Kh√¥ng x√°c ƒë·ªãnh';
    }
}
</script>
{% endblock %}