<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th∆∞ vi·ªán vƒÉn m·∫´u & L√Ω thuy·∫øt</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
        }
        #library {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        .dataTables_wrapper {
            margin-top: 20px;
        }
        .btn-action {
            margin-right: 5px;
        }
        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        dialog {
            border: none;
            border-radius: 10px;
            padding: 0;
            max-width: 90%;
            width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-content {
            border-radius: 10px;
        }
        .form-label {
            font-weight: 500;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    {% include "base.html" %}
    <section id="library">
        <h2 class="text-center mb-4">Th∆∞ vi·ªán vƒÉn m·∫´u & L√Ω thuy·∫øt</h2>

        <!-- Navigation Tabs -->
        <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <button class="nav-link active" id="nav-vanmau-tab" data-bs-toggle="tab" data-bs-target="#nav-vanmau" type="button" role="tab" aria-controls="nav-vanmau" aria-selected="true">Th∆∞ vi·ªán vƒÉn m·∫´u</button>
                <button class="nav-link" id="nav-lythuyet-tab" data-bs-toggle="tab" data-bs-target="#nav-lythuyet" type="button" role="tab" aria-controls="nav-lythuyet" aria-selected="false">L√Ω thuy·∫øt</button>
            </div>
        </nav>

        <!-- Tab Content -->
        <div class="tab-content" id="nav-tabContent">
            <!-- Tab 1: Th∆∞ vi·ªán vƒÉn m·∫´u -->
            <div class="tab-pane fade show active" id="nav-vanmau" role="tabpanel" aria-labelledby="nav-vanmau-tab">
                <!-- N√∫t th√™m t√†i li·ªáu cho admin -->
                <div class="admin-actions mt-3 mb-3" style="display: none;">
                    <button class="btn btn-primary" onclick="openAddDocumentDialog('vanmau')">+ Th√™m vƒÉn m·∫´u m·ªõi</button>
                </div>
                <table id="vanmau-table" class="table table-striped table-bordered" style="width:100%">
                    <thead>
                        <tr>
                            <th>Ti√™u ƒë·ªÅ</th>
                            <th>T√°c gi·∫£</th>
                            <th>L·ªõp</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated here dynamically -->
                    </tbody>
                </table>
            </div>

            <!-- Tab 2: L√Ω thuy·∫øt -->
            <div class="tab-pane fade" id="nav-lythuyet" role="tabpanel" aria-labelledby="nav-lythuyet-tab">
                <!-- N√∫t th√™m t√†i li·ªáu cho admin -->
                <div class="admin-actions mt-3 mb-3" style="display: none;">
                    <button class="btn btn-primary" onclick="openAddDocumentDialog('lythuyet')">+ Th√™m l√Ω thuy·∫øt m·ªõi</button>
                </div>
                <table id="lythuyet-table" class="table table-striped table-bordered" style="width:100%">
                    <thead>
                        <tr>
                            <th>Ti√™u ƒë·ªÅ</th>
                            <th>T√°c gi·∫£</th>
                            <th>L·ªõp</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated here dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Dialog for Adding/Editing Documents -->
    <dialog id="add-document-dialog" class="dialog modal-dialog-scrollable">
        <div class="modal-content p-4">
            <div class="modal-header">
                <h3 id="dialog-title" class="modal-title">Th√™m t√†i li·ªáu m·ªõi</h3>
                <button type="button" class="btn-close" onclick="closeAddDocumentDialog()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="document-form">
                    <input type="hidden" id="doc-id">
                    
                    <div class="mb-3">
                        <label for="doc-title" class="form-label">
                            <i class="bi bi-file-earmark-text"></i> Ti√™u ƒë·ªÅ
                        </label>
                        <input type="text" id="doc-title" class="form-control" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ t√†i li·ªáu" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="doc-content" class="form-label">
                            <i class="bi bi-textarea-t"></i> N·ªôi dung
                        </label>
                        <textarea id="doc-content" class="form-control" rows="5" placeholder="Nh·∫≠p n·ªôi dung t√†i li·ªáu" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="doc-files" class="form-label">
                            <i class="bi bi-upload"></i> T·∫£i l√™n t·ªáp
                        </label>
                        <input type="file" id="doc-files" class="form-control" multiple>
                        <div class="form-text">C√≥ th·ªÉ ch·ªçn nhi·ªÅu t·ªáp c√πng l√∫c</div>
                        <div id="file-list-container" class="mt-2"></div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="doc-category" class="form-label">
                                <i class="bi bi-tag"></i> Danh m·ª•c
                            </label>
                            <select id="doc-category" class="form-select" required>
                                <option value="vanmau">VƒÉn m·∫´u</option>
                                <option value="lythuyet">L√Ω thuy·∫øt</option>
                            </select>
                            <div class="form-text">Ch·ªçn ƒë√∫ng danh m·ª•c ƒë·ªÉ ph√¢n lo·∫°i t√†i li·ªáu</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="doc-grade" class="form-label">
                                <i class="bi bi-mortarboard"></i> L·ªõp
                            </label>
                            <input type="text" id="doc-grade" class="form-control" placeholder="Vd: 10, 11, 12, ƒê·∫°i h·ªçc" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="doc-author" class="form-label">
                            <i class="bi bi-person"></i> T√°c gi·∫£
                        </label>
                        <input type="text" id="doc-author" class="form-control" placeholder="T√™n t√°c gi·∫£" required>
                    </div>
                    
                    <div id="loading-spinner" class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang l∆∞u...</span>
                        </div>
                        <p class="mt-2">ƒêang x·ª≠ l√Ω, vui l√≤ng ƒë·ª£i...</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddDocumentDialog()">
                    <i class="bi bi-x-circle"></i> H·ªßy
                </button>
                <button class="btn btn-success" onclick="saveDocument()">
                    <i class="bi bi-save"></i> L∆∞u t√†i li·ªáu
                </button>
            </div>
        </div>
    </dialog>

    <!-- Bootstrap 5 JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script>
        let vanmauTable, lythuyetTable;
        let currentTab = 'vanmau';

        document.addEventListener("DOMContentLoaded", function () {
            checkAdminAccess();
            initializeTables();
            fetchDataForTables();
            
            // Theo d√µi s·ª± ki·ªán chuy·ªÉn tab
            document.getElementById('nav-vanmau-tab').addEventListener('click', function() {
                currentTab = 'vanmau';
            });
            
            document.getElementById('nav-lythuyet-tab').addEventListener('click', function() {
                currentTab = 'lythuyet';
            });
        });

        function checkAdminAccess() {
            const level = localStorage.getItem("level");
            const user = JSON.parse(localStorage.getItem('user'));
            const isAdmin = user && (user.level === "admin" || level === "admin");
            
            // Hi·ªÉn th·ªã c√°c n√∫t th√™m t√†i li·ªáu n·∫øu l√† admin
            const adminActionButtons = document.querySelectorAll('.admin-actions');
            adminActionButtons.forEach(button => {
                button.style.display = isAdmin ? 'block' : 'none';
            });
        }

        function initializeTables() {
            vanmauTable = $('#vanmau-table').DataTable({
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json"
                },
                columns: [
                    { data: 'title' },
                    { data: 'author' },
                    { data: 'grade' },
                    {
                        data: null,
                        render: function (data, type, row) {
                            return `
                                <button class="btn btn-info btn-action" onclick="viewDocument('${row._id}')">üìñ Xem</button>
                                ${isAdmin() ? `
                                    <button class="btn btn-warning btn-action" onclick="editDocument('${row._id}')">‚úèÔ∏è S·ª≠a</button>
                                    <button class="btn btn-danger btn-action" onclick="deleteDocument('${row._id}')">üóë X√≥a</button>
                                ` : ''}
                            `;
                        }
                    }
                ]
            });

            lythuyetTable = $('#lythuyet-table').DataTable({
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json"
                },
                columns: [
                    { data: 'title' },
                    { data: 'author' },
                    { data: 'grade' },
                    {
                        data: null,
                        render: function (data, type, row) {
                            return `
                                <button class="btn btn-info btn-action" onclick="viewDocument('${row._id}')">üìñ Xem</button>
                                ${isAdmin() ? `
                                    <button class="btn btn-warning btn-action" onclick="editDocument('${row._id}')">‚úèÔ∏è S·ª≠a</button>
                                    <button class="btn btn-danger btn-action" onclick="deleteDocument('${row._id}')">üóë X√≥a</button>
                                ` : ''}
                            `;
                        }
                    }
                ]
            });
        }

        async function fetchDataForTables() {
            try {
                const response = await fetch("/api/fetch-document");
                const data = await response.json();

                // Ph√¢n lo·∫°i d·ªØ li·ªáu d·ª±a tr√™n category
                const vanmauData = data.filter(doc => doc.category.toLowerCase() === 'vanmau');
                const lythuyetData = data.filter(doc => doc.category.toLowerCase() === 'lythuyet');

                vanmauTable.clear().rows.add(vanmauData).draw();
                lythuyetTable.clear().rows.add(lythuyetData).draw();
            } catch (error) {
                console.error("L·ªói t·∫£i d·ªØ li·ªáu:", error);
            }
        }

        function isAdmin() {
            const user = JSON.parse(localStorage.getItem('user'));
            return user && user.level === "admin";
        }

        function viewDocument(id) {
            window.location.href = `/view-library/${id}`;
        }

        function editDocument(id) {
            const token = localStorage.getItem("token");
            const headers = token ? { Authorization: `Bearer ${token}` } : {};

            fetch(`/api/document/${id}`, {
                method: "GET",
                headers: headers,
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const post = data.document;
                        document.getElementById("dialog-title").textContent = "Ch·ªânh s·ª≠a t√†i li·ªáu";
                        document.getElementById("doc-id").value = post._id;
                        document.getElementById("doc-title").value = post.title;
                        document.getElementById("doc-content").value = post.content;
                        
                        // Thi·∫øt l·∫≠p category t·ª´ d·ªØ li·ªáu
                        const categorySelect = document.getElementById("doc-category");
                        for (let i = 0; i < categorySelect.options.length; i++) {
                            if (categorySelect.options[i].value === post.category) {
                                categorySelect.selectedIndex = i;
                                break;
                            }
                        }
                        
                        document.getElementById("doc-grade").value = post.grade;
                        document.getElementById("doc-author").value = post.author;
                        document.getElementById("doc-files").value = "";

                        // Hi·ªÉn th·ªã danh s√°ch t·ªáp tin ƒë√£ t·∫£i l√™n (n·∫øu c√≥)
                        const fileListContainer = document.getElementById("file-list-container");
                        fileListContainer.innerHTML = "";
                        
                        if (post.files && post.files.length > 0) {
                            const fileListHTML = `
                                <div class="mt-3">
                                    <h6>T·ªáp ƒë√£ t·∫£i l√™n:</h6>
                                    <ul class="list-group">
                                        ${post.files.map(file => `<li class="list-group-item">${file}</li>`).join('')}
                                    </ul>
                                </div>
                            `;
                            fileListContainer.innerHTML = fileListHTML;
                        }

                        document.getElementById("add-document-dialog").showModal();
                    } else {
                        alert("C√≥ l·ªói x·∫£y ra khi t·∫£i t√†i li·ªáu.");
                    }
                })
                .catch(error => {
                    console.error("L·ªói khi t·∫£i t√†i li·ªáu:", error);
                });
        }

        function deleteDocument(id) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i li·ªáu n√†y?")) return;

            const token = localStorage.getItem("token");
            const headers = token ? { Authorization: `Bearer ${token}` } : {};

            fetch(`/api/delete-document/${id}`, {
                method: "DELETE",
                headers: headers,
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("T√†i li·ªáu ƒë√£ x√≥a th√†nh c√¥ng.");
                        fetchDataForTables(); // Refresh the table
                    } else {
                        alert("C√≥ l·ªói x·∫£y ra khi x√≥a t√†i li·ªáu.");
                    }
                })
                .catch(error => {
                    console.error("L·ªói khi x√≥a t√†i li·ªáu:", error);
                });
        }

        function openAddDocumentDialog(tab) {
            const user = localStorage.getItem("user");
            if (!user) {
                alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p th∆∞ vi·ªán.");
                window.location.href = "/login";
            } else {
                document.getElementById("dialog-title").textContent = "Th√™m t√†i li·ªáu m·ªõi";
                document.getElementById("doc-id").value = "";
                document.getElementById("doc-title").value = "";
                document.getElementById("doc-content").value = "";
                
                // Thi·∫øt l·∫≠p category d·ª±a tr√™n tab hi·ªán t·∫°i
                const categorySelect = document.getElementById("doc-category");
                for (let i = 0; i < categorySelect.options.length; i++) {
                    if (categorySelect.options[i].value === tab) {
                        categorySelect.selectedIndex = i;
                        break;
                    }
                }
                
                document.getElementById("doc-grade").value = "";
                document.getElementById("doc-author").value = "";
                document.getElementById("doc-files").value = "";

                // X√≥a danh s√°ch t·ªáp c≈© (n·∫øu c√≥)
                document.getElementById("file-list-container").innerHTML = "";
                
                document.getElementById("add-document-dialog").showModal();
            }
        }

        function closeAddDocumentDialog() {
            document.getElementById("add-document-dialog").close();
        }

        function saveDocument() {
            // Thu th·∫≠p d·ªØ li·ªáu t·ª´ form
            const docId = document.getElementById('doc-id').value;
            const title = document.getElementById('doc-title').value;
            const content = document.getElementById('doc-content').value;
            const category = document.getElementById('doc-category').value;
            const grade = document.getElementById('doc-grade').value;
            const author = document.getElementById('doc-author').value;
            const files = document.getElementById('doc-files').files;

            // X√°c th·ª±c d·ªØ li·ªáu
            if (!title || !content || !category || !grade || !author) {
                alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc.");
                return;
            }

            // Hi·ªán loading spinner
            document.getElementById('loading-spinner').style.display = 'block';

            // Chu·∫©n b·ªã d·ªØ li·ªáu
            const formData = new FormData();
            formData.append('title', title);
            formData.append('content', content);
            formData.append('category', category);
            formData.append('grade', grade);
            formData.append('author', author);

            // Th√™m c√°c t·ªáp v√†o formData
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            // L·∫•y token t·ª´ localStorage
            const token = localStorage.getItem('token');
            const headers = {};
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            // X√°c ƒë·ªãnh API endpoint (th√™m m·ªõi ho·∫∑c c·∫≠p nh·∫≠t)
            let url = '/api/add-document';
            let method = 'POST';

            if (docId) {
                url = `/api/update-document/${docId}`;
                method = 'PUT';
            }

            // G·ª≠i y√™u c·∫ßu ƒë·∫øn server
            fetch(url, {
                method: method,
                headers: headers,
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // ·∫®n loading spinner
                document.getElementById('loading-spinner').style.display = 'none';

                if (data.success) {
                    alert(docId ? "T√†i li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!" : "T√†i li·ªáu ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!");
                    closeAddDocumentDialog();
                    fetchDataForTables(); // C·∫≠p nh·∫≠t l·∫°i b·∫£ng d·ªØ li·ªáu
                } else {
                    alert("C√≥ l·ªói x·∫£y ra: " + (data.message || data.error || "Kh√¥ng th·ªÉ l∆∞u t√†i li·ªáu"));
                }
            })
            .catch(error => {
                // ·∫®n loading spinner
                document.getElementById('loading-spinner').style.display = 'none';
                console.error("L·ªói khi l∆∞u t√†i li·ªáu:", error);
                alert("C√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng th·ª≠ l·∫°i sau.");
            });
        }
    </script>
</body>
</html>