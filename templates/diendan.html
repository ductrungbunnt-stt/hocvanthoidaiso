{% extends "base.html" %}

{% block title %}Di·ªÖn ƒë√†n - VƒÉn h·ªçc th·ªùi ƒë·∫°i s·ªë{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://gist.githubusercontent.com/cuclacvangsanh/059ab08aa913a5bf4aebc5313e426422/raw/a0c9ed471bc4e9abd1ceafb7837fec195fe9eeec/diendanstyle.css">
<div class="container-fluid py-4">
    <div class="row">
        <!-- Left Sidebar -->
        <div class="col-lg-3 d-none d-lg-block">
            <div class="sidebar-fixed">
                <div class="site-logo mb-5 ps-3">
                    <h4 class="fw-bold">H·ªçc VƒÉn Th·ªùi ƒê·∫°i S·ªë</h4>
                </div>
                <div class="list-group list-group-flush">
                    <a href="#" class="list-group-item list-group-item-action instagram-nav-item">
                        <i class="fas fa-home me-2"></i> Trang ch·ªß
                    </a>
                   
                   
                    <a href="/messenger" class="list-group-item list-group-item-action instagram-nav-item">
                        <i class="fas fa-paper-plane me-2"></i> Tin nh·∫Øn
                    </a>
                  
                    <a href="#" class="list-group-item list-group-item-action instagram-nav-item" data-bs-toggle="modal" data-bs-target="#createPostModal">
                        <i class="fas fa-plus-square me-2"></i> T·∫°o b√†i vi·∫øt
                    </a>
                    
                </div>
               
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-6 col-md-8 mx-auto">
            <!-- Stories -->
        

            <!-- Posts Feed -->
            <div id="posts-container">
                <!-- Posts will be loaded here -->
            </div>
        </div>

        <!-- Right Sidebar -->
        
    </div>
</div>

<!-- Create Post Modal -->
<div class="modal fade" id="createPostModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">T·∫°o b√†i vi·∫øt m·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <textarea class="form-control" id="post-content" rows="4" placeholder="Chia s·∫ª suy nghƒ© c·ªßa b·∫°n..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Th√™m ·∫£nh/video</label>
                    <input type="file" class="form-control" id="post-media" accept="image/*,video/*">
                </div>
                <div id="media-preview" class="mb-3 d-none">
                    <img id="preview-image" class="img-fluid rounded" style="max-height: 300px;">
                    <button class="btn btn-sm btn-danger mt-2" onclick="removeMedia()">
                        <i class="fas fa-times"></i> X√≥a
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="createPost()">ƒêƒÉng</button>
            </div>
        </div>
    </div>
</div>

<!-- Comment Modal -->
<div class="modal fade" id="commentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">B√¨nh lu·∫≠n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="comments-container" class="mb-3">
                    <!-- Comments will be loaded here -->
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" id="comment-input" placeholder="Vi·∫øt b√¨nh lu·∫≠n...">
                    <button class="btn btn-primary" onclick="submitComment()">G·ª≠i</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Post Modal -->
<div class="modal fade" id="editPostModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ch·ªânh s·ª≠a b√†i vi·∫øt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-post-id">
                <div class="mb-3">
                    <textarea class="form-control" id="edit-post-content" rows="4" placeholder="Chia s·∫ª suy nghƒ© c·ªßa b·∫°n..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Thay ƒë·ªïi ·∫£nh/video</label>
                    <input type="file" class="form-control" id="edit-post-media" accept="image/*,video/*">
                </div>
                <div id="edit-media-preview" class="mb-3">
                    <img id="edit-preview-image" class="img-fluid rounded" style="max-height: 300px;">
                    <button class="btn btn-sm btn-danger mt-2" onclick="removeEditMedia()">
                        <i class="fas fa-times"></i> X√≥a
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="updatePost()">C·∫≠p nh·∫≠t</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal ƒë·ªïi t√™n ng∆∞·ªùi d√πng -->
<!-- <div class="modal fade" id="changeUsernameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ƒê·ªïi t√™n ng∆∞·ªùi d√πng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new-username" class="form-label">T√™n m·ªõi c·ªßa b·∫°n</label>
                    <input type="text" class="form-control" id="new-username" placeholder="Nh·∫≠p t√™n m·ªõi...">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="changeUsername()">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>
</div> -->

    <style>
      body {
    background-color: #fafafa;
}

.card {
    border: none;
    border-radius: 8px;
    background-color: #fff;
    margin-bottom: 20px;
}

.sidebar-fixed {
    position: sticky;
    top: 20px;
    height: calc(100vh - 40px);
        display: flex;
        flex-direction: column;
}

.instagram-nav-item {
    border-radius: 8px;
    margin-bottom: 5px;
    font-weight: 500;
    transition: all 0.2s;
    color: #262626;
}

.instagram-nav-item:hover, .instagram-nav-item.active {
    background-color: #f8f9fa;
    color: #262626;
}

.instagram-nav-item i {
    color: #262626;
}

.dropdown-item:hover {
    background-color: #f8f9fa;
}

.dropdown-item i.fa-edit {
    color: #0095f6;
}

.dropdown-item i.fa-trash {
    color: #ed4956;
}

.edit-success,
.delete-success {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(38, 38, 38, 0.9);
        color: white;
    padding: 10px 20px;
    border-radius: 4px;
    z-index: 1050;
    display: none;
}

.stories-container {
    padding: 10px;
    scrollbar-width: none;
}

.stories-container::-webkit-scrollbar {
    display: none;
}

.story-item {
    text-align: center;
}

.story-circle {
    width: 70px;
    height: 70px;
    padding: 2px;
    background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
    border-radius: 50%;
    margin-bottom: 5px;
    cursor: pointer;
}

.story-circle img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border: 3px solid #fff;
    border-radius: 50%;
}

.post-card {
    margin-bottom: 20px;
        border-radius: 8px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.post-header {
    padding: 12px;
    border-bottom: 1px solid #efefef;
        display: flex;
        align-items: center;
    justify-content: space-between;
}

.post-user {
    display: flex;
    align-items: center;
}

.post-user img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    margin-right: 10px;
}

.post-content {
    padding: 0;
}

.post-image {
    width: 100%;
    max-height: 600px;
    object-fit: cover;
}

.post-actions {
    padding: 12px;
}

.post-likes {
    padding: 0 12px;
    margin-bottom: 8px;
}

.post-caption {
    padding: 0 12px 12px;
}

.post-time {
    padding: 0 12px 12px;
    color: #8e8e8e;
    font-size: 12px;
    text-transform: uppercase;
}

.comment-item {
    padding: 8px 0;
    border-bottom: 1px solid #efefef;
}

.comment-item:last-child {
    border-bottom: none;
}

.btn-instagram {
    background-color: #0095f6;
        color: white;
        border: none;
    border-radius: 4px;
    padding: 5px 10px;
    font-weight: 600;
}

.btn-instagram:hover {
    background-color: #0086e0;
    color: white;
}

.like-button.active i {
    color: #ed4956;
    font-weight: 900;
}

/* Th√™m CSS cho n√∫t like */
button[id^="like-button-"].active i {
    color: #ed4956 !important;
    font-weight: 900;
}

button[id^="like-button-"]:hover i {
    transform: scale(1.1);
    transition: transform 0.2s;
}

button[id^="like-button-"].active:hover i {
    color: #ed4956 !important;
}

.heart-animation {
    animation: heartBeat 0.5s;
}

@keyframes heartBeat {
    0% { transform: scale(1); }
    25% { transform: scale(1.2); }
    50% { transform: scale(1); }
    75% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.modal-content {
    border-radius: 12px;
    border: none;
}

#posts-container {
    max-width: 600px;
    margin: 0 auto;
}

@media (max-width: 991.98px) {
    #posts-container {
        max-width: 100%;
        }
      }
    </style>

    <script>
let likedPosts = new Set();
let nextPostId = 1;

async function createPost() {
    const content = document.getElementById('post-content').value;
    const media = document.getElementById('post-media').files[0];
    const user = JSON.parse(localStorage.getItem("user")); // L·∫•y user t·ª´ localStorage
    const username = user ? user.username : "Anonymous"; // ‚úÖ L·∫•y username t·ª´ localStorage ho·∫∑c m·∫∑c ƒë·ªãnh l√† "Anonymous"

    if (!content && !media) {
        alert('Vui l√≤ng nh·∫≠p n·ªôi dung ho·∫∑c th√™m ·∫£nh/video');
        return;
    }

    const formData = new FormData();
    formData.append('content', content);
    if (media) formData.append('media', media);
    formData.append('username', username); // ‚úÖ G·ª≠i username l√™n API

    try {
        const response = await fetch('http://127.0.0.1:8000/api/posts', {
            method: 'POST',
            body: formData
        });

        console.log("Response status:", response.status);
        console.log("Response headers:", response.headers);

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        console.log("Response data:", data); // ‚úÖ Xem JSON tr·∫£ v·ªÅ

        if (data.success) {
            addPostToFeed(data.post);  // ‚úÖ Hi·ªÉn th·ªã b√†i vi·∫øt trong feed
            alert("B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!");
            const modal = bootstrap.Modal.getInstance(document.getElementById('createPostModal'));
            modal.hide();
            
        } else {
            alert("L·ªói: " + data.message);
        }
    } catch (error) {
        console.error('L·ªói khi t·∫°o b√†i vi·∫øt:', error);
        alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!');
    }
}


function addPostToFeed(post) {
    const container = document.getElementById('posts-container');
    const postElement = document.createElement('div');
    postElement.className = 'card post-card';

    // Ki·ªÉm tra xem b√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c th√≠ch ch∆∞a (gi·∫£ s·ª≠ likedPosts l√† Set to√†n c·ª•c)
    const isLiked = likedPosts.has(post._id);

    // Ki·ªÉm tra quy·ªÅn s·ªü h·ªØu b√†i vi·∫øt (so s√°nh v·ªõi currentUserName to√†n c·ª•c)
    const isOwner = post.user.name === currentUserName;

    postElement.innerHTML = `
        <div class="post-header">
            <div class="post-user">
                <img src="${post.user.avatar || getRandomAvatar()}" alt="${post.user.name}">
                <div>
                    <div class="fw-bold">${post.user.name}</div>
                </div>
            </div>
            <div class="dropdown">
                <button class="btn text-dark p-0" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    ${isOwner ? `
                    <li><a class="dropdown-item" href="#" onclick="editPost('${post._id}')"><i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a</a></li>
                    <li><a class="dropdown-item" href="#" onclick="deletePost('${post._id}')"><i class="fas fa-trash me-2"></i>X√≥a</a></li>
                    ` : `
                    <li><a class="dropdown-item" href="#" onclick="reportPost('${post._id}')"><i class="fas fa-flag me-2"></i>B√°o c√°o</a></li>
                    `}
                </ul>
            </div>
        </div>
        ${post.media_url ? `
            <div class="post-content">
                <img src="${post.media_url}" class="post-image">
            </div>
        ` : ''}
        <div class="post-actions">
            <div class="d-flex align-items-center mb-2">
                <button class="btn btn-link text-dark p-0 me-3 ${isLiked ? 'active' : ''}" id="like-button-${post._id}" onclick="likePost('${post._id}')">
                    <i class="${isLiked ? 'fas' : 'far'} fa-heart fa-lg" style="${isLiked ? 'color: #ed4956;' : ''}"></i>
                </button>
                <button class="btn btn-link text-dark p-0 me-3" onclick="openComments('${post._id}')">
                    <i class="far fa-comment fa-lg"></i>
                </button>
                <button class="btn btn-link text-dark p-0" id="share-button-${post._id}" onclick="sharePost('${post._id}')">
                    <i class="far fa-paper-plane fa-lg"></i>
                </button>
            </div>
        </div>
        <div class="post-likes">
            <div class="fw-bold"><span id="like-count-${post._id}">${post.likes || 0}</span> l∆∞·ª£t th√≠ch</div>
        </div>
        <div class="post-caption">
            <span class="fw-bold">${post.user.name}</span> ${post.content}
        </div>
        <div class="post-time">
            ${post.updated_at ? post.updated_at : (post.created_at || 'V·ª´a xong')}
        </div>
    `;
    container.insertBefore(postElement, container.firstChild);
}

// Load b√†i vi·∫øt m·ªõi nh·∫•t
async function loadPosts() {
    try {
        const response = await fetch('/api/all/posts');

        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ t·∫£i b√†i vi·∫øt m·ªõi');
        }

        const data = await response.json();
        const container = document.getElementById('posts-container');
        container.innerHTML = ''; // X√≥a d·ªØ li·ªáu c≈© trong b·∫£ng

        // Ki·ªÉm tra n·∫øu c√≥ b√†i vi·∫øt
        if (data && data.length > 0) {
            // D√πng h√†m addPostToFeed ƒë·ªÉ th√™m b√†i vi·∫øt v√†o feed
            data.forEach(post => {
                addPostToFeed(post); // G·ªçi h√†m addPostToFeed
            });
        } else {
            container.innerHTML = '<div class="text-center">Ch∆∞a c√≥ b√†i vi·∫øt n√†o</div>';
        }

    } catch (error) {
        console.error('L·ªói khi t·∫£i b√†i vi·∫øt m·ªõi:', error);
        document.getElementById('posts-container').innerHTML = 
            '<div class="text-center text-danger">Kh√¥ng th·ªÉ t·∫£i b√†i vi·∫øt m·ªõi</div>';
    }
}



// Danh s√°ch avatar th·ª±c t·∫ø ƒë·ªÉ thay th·∫ø placeholder
const avatarUrls = [
    'https://randomuser.me/api/portraits/women/12.jpg',
    'https://randomuser.me/api/portraits/men/32.jpg',
    'https://randomuser.me/api/portraits/women/32.jpg',
    'https://randomuser.me/api/portraits/men/22.jpg',
    'https://randomuser.me/api/portraits/women/22.jpg',
    'https://randomuser.me/api/portraits/men/11.jpg',
    'https://randomuser.me/api/portraits/women/11.jpg',
    'https://randomuser.me/api/portraits/men/1.jpg',
    'https://randomuser.me/api/portraits/women/1.jpg',
    'https://randomuser.me/api/portraits/men/2.jpg'
];

// Danh s√°ch t√™n ng∆∞·ªùi d√πng ng·∫´u nhi√™n


// Bi·∫øn l∆∞u t√™n ng∆∞·ªùi d√πng hi·ªán t·∫°i
let currentUserName = '';
document.addEventListener("DOMContentLoaded", function () {
    let username = localStorage.getItem("username") || "Ng∆∞·ªùi d√πng";
    document.getElementById("profile-username").textContent = username;
});

// Kh·ªüi t·∫°o ng∆∞·ªùi d√πng hi·ªán t·∫°i khi t·∫£i trang
function initCurrentUser() {
    // L·∫•y ng∆∞·ªùi d√πng t·ª´ localStorage n·∫øu ƒë√£ c√≥
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        currentUserName = savedUser;
    } else {
        // N·∫øu ch∆∞a c√≥, t·∫°o ng∆∞·ªùi d√πng m·ªõi
        currentUserName = getRandomUserName();
        localStorage.setItem('currentUser', currentUserName);
    }
    
    // Hi·ªÉn th·ªã t√™n ng∆∞·ªùi d√πng trong sidebar
    updateProfileName();
}

// C·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng hi·ªÉn th·ªã trong sidebar
function updateProfileName() {
    const profileLink = document.querySelector('.list-group-item img[alt="avatar"]').closest('.list-group-item');
    if (profileLink) {
        let username = localStorage.getItem("username") || "Ng∆∞·ªùi d√πng";
        // T·∫°o icon menu nh·ªè b√™n c·∫°nh t√™n
        const currentHTML = profileLink.innerHTML;
        // Thay th·∫ø to√†n b·ªô n·ªôi dung sau avatar
        const newContent = `<img src="https://via.placeholder.com/30" class="rounded-circle me-2" alt="avatar" style="width: 24px; height: 24px;"> 
            <span>${username}</span>
            <i class="fas fa-cog ms-2 text-muted" style="font-size: 12px; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#changeUsernameModal"></i>`;
        profileLink.innerHTML = newContent;
        
        // Replace avatar with random one
        const avatarImg = profileLink.querySelector('img');
        if (avatarImg && avatarImg.src.includes('placeholder')) {
            avatarImg.src = getRandomAvatar();
        }
    }
}

// ƒê·ªïi t√™n ng∆∞·ªùi d√πng
function changeUsername() {
    const newUsername = document.getElementById('new-username').value.trim();
    
    if (!newUsername) {
        alert('Vui l√≤ng nh·∫≠p t√™n m·ªõi');
        return;
    }
    
    // L∆∞u t√™n c≈© ƒë·ªÉ c·∫≠p nh·∫≠t c√°c b√†i vi·∫øt
    const oldUsername = currentUserName;
    
    // C·∫≠p nh·∫≠t t√™n m·ªõi
    currentUserName = newUsername;
    localStorage.setItem('currentUser', currentUserName);
    
    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
    updateProfileName();
    
    // C·∫≠p nh·∫≠t t√™n trong c√°c b√†i vi·∫øt c·ªßa ng∆∞·ªùi d√πng
    let posts = JSON.parse(localStorage.getItem('posts') || '[]');
    posts = posts.map(post => {
        if (post.user.name === oldUsername) {
            post.user.name = currentUserName;
        }
        return post;
    });
    localStorage.setItem('posts', JSON.stringify(posts));
    
    // Refresh l·∫°i feed
    refreshPostFeed();
    
    // ƒê√≥ng modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('changeUsernameModal'));
    modal.hide();
    
    // Reset form
    document.getElementById('new-username').value = '';
    
    // Th√¥ng b√°o th√†nh c√¥ng
    showUsernameChangeSuccess();
}

function showUsernameChangeSuccess() {
    // T·∫°o ph·∫ßn t·ª≠ th√¥ng b√°o n·∫øu ch∆∞a t·ªìn t·∫°i
    let notification = document.querySelector('.username-change-success');
    if (!notification) {
        notification = document.createElement('div');
        notification.className = 'username-change-success';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(38, 38, 38, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 1050;
        `;
        notification.innerHTML = '<i class="fas fa-check-circle me-2"></i>T√™n ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t';
        document.body.appendChild(notification);
    }
    
    // Hi·ªÉn th·ªã th√¥ng b√°o
    notification.style.display = 'block';
    
    // ·∫®n th√¥ng b√°o sau 3 gi√¢y
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// Danh s√°ch c√°c t√™n ng∆∞·ªùi n·ªïi ti·∫øng v·ªÅ vƒÉn h·ªçc
const famousAuthors = [
    'Nh√† vƒÉn Nguy·ªÖn Nh·∫≠t √Ånh',
    'Nh√† th∆° Xu√¢n Qu·ª≥nh',
    'Nh√† vƒÉn Nam Cao',
    'Nh√† th∆° Xu√¢n Di·ªáu',
    'Nh√† vƒÉn Nguy·ªÖn Ng·ªçc T∆∞',
    'Nh√† th∆° T·ªë H·ªØu',
    'Nh√† vƒÉn T√¥ Ho√†i',
    'Nh√† th∆° Huy C·∫≠n',
    'Nh√† vƒÉn V≈© Tr·ªçng Ph·ª•ng',
    'Nh√† th∆° Ch·∫ø Lan Vi√™n'
];

// Danh s√°ch c√°c l√Ω do g·ª£i √Ω
const suggestionReasons = [
    'M·ªõi tham gia',
    'Theo d√µi b·ªüi b·∫°n b√®',
    'Ph·ªï bi·∫øn trong tu·∫ßn n√†y',
    'ƒê∆∞·ª£c ƒë·ªÅ xu·∫•t cho b·∫°n',
    'C√πng s·ªü th√≠ch v·ªõi b·∫°n',
    'Ho·∫°t ƒë·ªông t√≠ch c·ª±c',
    'Ng∆∞·ªùi d√πng m·ªõi n·ªïi',
    'C√≥ n·ªôi dung t∆∞∆°ng t·ª±',
    'Ng∆∞·ªùi theo d√µi b·∫°n',
    'B·∫°n c√≥ th·ªÉ bi·∫øt'
];

// L·∫•y avatar ng·∫´u nhi√™n t·ª´ danh s√°ch
function getRandomAvatar() {
    const randomIndex = Math.floor(Math.random() * avatarUrls.length);
    return avatarUrls[randomIndex];
}

// L·∫•y t√™n ng∆∞·ªùi d√πng ng·∫´u nhi√™n t·ª´ danh s√°ch


// L·∫•y t√™n t√°c gi·∫£ ng·∫´u nhi√™n t·ª´ danh s√°ch
function getRandomAuthor() {
    const randomIndex = Math.floor(Math.random() * famousAuthors.length);
    return famousAuthors[randomIndex];
}

// L·∫•y l√Ω do g·ª£i √Ω ng·∫´u nhi√™n
function getRandomSuggestionReason() {
    const randomIndex = Math.floor(Math.random() * suggestionReasons.length);
    return suggestionReasons[randomIndex];
}
function getRandomUserName() {
    const user = localStorage.getItem('user');
	console.log("üîπ D·ªØ li·ªáu trong localStorage:", localStorage.getItem('user'));
    return user ? JSON.parse(user) : null;
}
// Thay th·∫ø placeholder avatar trong trang
function replacePlaceholderAvatars() {
    const avatarImgs = document.querySelectorAll('img[src*="placeholder.com"]');
    avatarImgs.forEach(img => {
        if (img.src.includes('placeholder')) {
            img.src = getRandomAvatar();
        }
    });
    
    // Thay th·∫ø t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ c√≥ n·ªôi dung "T√™n ng∆∞·ªùi d√πng"
    document.querySelectorAll('.story-item small').forEach(el => {
        el.textContent = getRandomUserName();
    });
    
    // Thay th·∫ø t√™n ng∆∞·ªùi d√πng trong ph·∫ßn suggestions
    const suggestionsNames = document.querySelectorAll('.suggestions-list .fw-bold');
    suggestionsNames.forEach(el => {
        el.textContent = getRandomUserName();
    });
    
    // Thay th·∫ø l√Ω do g·ª£i √Ω trong ph·∫ßn suggestions
    document.querySelectorAll('.suggestions-list small.text-muted').forEach(el => {
        el.textContent = getRandomSuggestionReason();
    });
    
    // Thay th·∫ø t√™n ng∆∞·ªùi d√πng trong header
    const headerUsername = document.querySelector('.card-body h6.mb-0');
    if (headerUsername && headerUsername.textContent === 'T√™n ng∆∞·ªùi d√πng') {
        headerUsername.textContent = getRandomUserName();
    }
    
    // Thay ƒë·ªïi username
    const smallUsername = document.querySelector('.card-body small.text-muted');
    if (smallUsername && smallUsername.textContent === '@username') {
        const name = getRandomUserName();
        smallUsername.textContent = '@' + name.toLowerCase().replace(/\s+/g, '_').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }
}

// Load liked posts from localStorage
function initializeLikedPosts() {
    const savedLikedPosts = localStorage.getItem('likedPosts');
    if (savedLikedPosts) {
        likedPosts = new Set(JSON.parse(savedLikedPosts));
    }
}

// Save liked posts to localStorage
function saveLikedPosts() {
    localStorage.setItem('likedPosts', JSON.stringify([...likedPosts]));
}



	



function previewMedia() {
    const file = document.getElementById('post-media').files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('preview-image').src = e.target.result;
            document.getElementById('media-preview').classList.remove('d-none');
        }
        reader.readAsDataURL(file);
    }
}

function removeMedia() {
    document.getElementById('post-media').value = '';
    document.getElementById('media-preview').classList.add('d-none');
}

async function likePost(postId) {
    try {
        const response = await fetch(`http://127.0.0.1:8000/forum/posts-like/${postId}`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ th·ª±c hi·ªán thao t√°c th√≠ch');
        }
        
        const data = await response.json();
        const button = document.querySelector(`#like-button-${postId}`);
        const count = document.querySelector(`#like-count-${postId}`);
        const heartIcon = button.querySelector('i');
        
        if (likedPosts.has(postId)) {
            // B·ªè th√≠ch
            likedPosts.delete(postId);
            button.classList.remove('active');
            heartIcon.className = 'far fa-heart fa-lg';
        } else {
            // Th√≠ch
            likedPosts.add(postId);
            button.classList.add('active');
            heartIcon.className = 'fas fa-heart fa-lg';
            
            // Th√™m hi·ªáu ·ª©ng ƒë·∫≠p cho tim
            heartIcon.classList.add('heart-animation');
            setTimeout(() => {
                heartIcon.classList.remove('heart-animation');
            }, 600);
        }
        
        count.textContent = data.likes;  // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng likes t·ª´ API
        saveLikedPosts();
    } catch (error) {
        console.error('L·ªói khi th·ª±c hi·ªán thao t√°c th√≠ch:', error);
        alert('Kh√¥ng th·ªÉ th·ª±c hi·ªán thao t√°c th√≠ch. Vui l√≤ng th·ª≠ l·∫°i sau.');
    }
}


function sharePost(postId) {
    const button = document.querySelector(`#share-button-${postId}`);
    
    // Ch·ªâ hi·ªÉn th·ªã hi·ªáu ·ª©ng chia s·∫ª
    button.classList.add('active');
    setTimeout(() => button.classList.remove('active'), 1000);
    
    // T·∫°o n·ªôi dung ƒë·ªÉ chia s·∫ª
    let posts = JSON.parse(localStorage.getItem('posts') || '[]');
    const post = posts.find(p => p.id == postId);
    
    if (post) {
        alert(`ƒê√£ sao ch√©p li√™n k·∫øt ƒë·∫øn b√†i vi·∫øt c·ªßa ${post.user.name}!`);
    }
}

async function loadComments(postId) {
    try {
        const response = await fetch(`/forum/posts-comments/${postId}`);
        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ t·∫£i b√¨nh lu·∫≠n');
        }
        
        const post = await response.json();
        const container = document.getElementById('comments-container');
        container.innerHTML = '';
        
        
        console.log("B√¨nh lu·∫≠n c·ªßa b√†i vi·∫øt:", post); // log b√¨nh lu·∫≠n ƒë·ªÉ ki·ªÉm tra
        if (post.comments && post.comments.length > 0) {
            post.comments.forEach(comment => {
                // log comment ƒë·ªÉ ki·ªÉm tra
                const commentElement = document.createElement('div');
                commentElement.className = 'comment-item';
                commentElement.innerHTML = `
                    <div class="d-flex align-items-center">
                        <img src="${getRandomAvatar()}" class="rounded-circle me-2" width="32" height="32">
                        <div>
                            <div class="fw-bold">${comment.author}</div>
                            <div>${comment.content}</div>
                        </div>
                    </div>
                `;
                container.appendChild(commentElement);
            });
        } else {
            container.innerHTML = '<p class="text-center p-3">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>';
        }
    } catch (error) {
        console.error('L·ªói khi t·∫£i b√¨nh lu·∫≠n:', error);
        document.getElementById('comments-container').innerHTML = '<p class="text-center p-3 text-danger">Kh√¥ng th·ªÉ t·∫£i b√¨nh lu·∫≠n. Vui l√≤ng th·ª≠ l·∫°i sau.</p>';
    }
}

async function submitComment() {
    const content = document.getElementById('comment-input').value;

    if (!content) {
        alert('Vui l√≤ng nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n');
        return;
    }

    // G·ª≠i b√¨nh lu·∫≠n ƒë·∫øn server
    try {
        const response = await fetch(`/forum/posts-comments-add/${window.currentPostId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                content: content,
                author: localStorage.getItem("username") || "Ng∆∞·ªùi d√πng"
            })
        });

        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ th√™m b√¨nh lu·∫≠n');
        }

        const data = await response.json();
        addCommentToPost(data.comment);
        document.getElementById('comment-input').value = ''; // Reset input
    } catch (error) {
        console.error('L·ªói khi th√™m b√¨nh lu·∫≠n:', error);
        alert('Kh√¥ng th·ªÉ th√™m b√¨nh lu·∫≠n. Vui l√≤ng th·ª≠ l·∫°i sau.');
    }
}


async function openComments(postId) {
    // L∆∞u ID c·ªßa b√†i vi·∫øt hi·ªán t·∫°i v√†o bi·∫øn to√†n c·ª•c
    window.currentPostId = postId;

    // M·ªü modal
    const modal = new bootstrap.Modal(document.getElementById('commentModal'));
    modal.show();

    // T·∫£i b√¨nh lu·∫≠n cho b√†i vi·∫øt n√†y
    await loadComments(postId);
}

let currentPostId;  // Make sure to assign the currentPostId when opening the modal for a specific post

	


function addCommentToPost(comment) {
    const commentsContainer = document.getElementById('comments-container');
    
    const commentElement = document.createElement('div');
    commentElement.className = 'comment';
    commentElement.innerHTML = `
        <p><strong>${comment.author}:</strong> ${comment.content}</p>
    `;

    commentsContainer.appendChild(commentElement);
}


function savePost(postId) {
    alert('ƒê√£ l∆∞u b√†i vi·∫øt!');
}




// Load posts when page loads
document.addEventListener('DOMContentLoaded', loadPosts);

// Preview media when file is selected
document.getElementById('post-media').addEventListener('change', previewMedia);

function editPost(postId) {
    // T√¨m post c·∫ßn ch·ªânh s·ª≠a
    let posts = JSON.parse(localStorage.getItem('posts') || '[]');
    const post = posts.find(p => p.id == postId);
    
    if (post) {
        // Hi·ªÉn th·ªã modal ch·ªânh s·ª≠a
        document.getElementById('edit-post-id').value = postId;
        document.getElementById('edit-post-content').value = post.content || '';
        
        // Hi·ªÉn th·ªã ·∫£nh hi·ªán t·∫°i n·∫øu c√≥
        const previewContainer = document.getElementById('edit-media-preview');
        const previewImage = document.getElementById('edit-preview-image');
        
        if (post.media) {
            previewImage.src = post.media;
            previewContainer.classList.remove('d-none');
        } else {
            previewContainer.classList.add('d-none');
        }
        
        // Hi·ªÉn th·ªã modal
        const modal = new bootstrap.Modal(document.getElementById('editPostModal'));
        modal.show();
    }
}

function removeEditMedia() {
    document.getElementById('edit-post-media').value = '';
    document.getElementById('edit-media-preview').classList.add('d-none');
    document.getElementById('edit-preview-image').src = '';
}

function updatePost() {
    const postId = document.getElementById('edit-post-id').value;
    const content = document.getElementById('edit-post-content').value;
    const media = document.getElementById('edit-post-media').files[0];
    
    if (!content && !media) {
        alert('Vui l√≤ng nh·∫≠p n·ªôi dung ho·∫∑c th√™m ·∫£nh/video');
        return;
    }
    
    // L·∫•y danh s√°ch posts t·ª´ localStorage
    let posts = JSON.parse(localStorage.getItem('posts') || '[]');
    
    // T√¨m post c·∫ßn c·∫≠p nh·∫≠t
    const postIndex = posts.findIndex(post => post.id == postId);
    
    if (postIndex !== -1) {
        if (media) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const mediaUrl = e.target.result;
                
                // C·∫≠p nh·∫≠t post
                posts[postIndex].content = content;
                posts[postIndex].media = mediaUrl;
                posts[postIndex].updated_at = 'V·ª´a c·∫≠p nh·∫≠t';
                
                // L∆∞u l·∫°i v√†o localStorage
                localStorage.setItem('posts', JSON.stringify(posts));
                
                // ƒê√≥ng modal v√† refresh trang ƒë·ªÉ hi·ªÉn th·ªã thay ƒë·ªïi
                const modal = bootstrap.Modal.getInstance(document.getElementById('editPostModal'));
                modal.hide();
                
                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                showEditSuccess();
                
                // Reload posts
                refreshPostFeed();
            };
            reader.readAsDataURL(media);
        } else {
            // L·∫•y media hi·ªán t·∫°i n·∫øu kh√¥ng c√≥ media m·ªõi
            const currentMedia = posts[postIndex].media;
            
            // C·∫≠p nh·∫≠t post
            posts[postIndex].content = content;
            
            // Gi·ªØ nguy√™n media c≈© n·∫øu kh√¥ng c√≥ file m·ªõi v√† kh√¥ng x√≥a
            if (document.getElementById('edit-media-preview').classList.contains('d-none')) {
                posts[postIndex].media = null;
            } else {
                posts[postIndex].media = currentMedia;
            }
            
            posts[postIndex].updated_at = 'V·ª´a c·∫≠p nh·∫≠t';
            
            // L∆∞u l·∫°i v√†o localStorage
            localStorage.setItem('posts', JSON.stringify(posts));
            
            // ƒê√≥ng modal v√† refresh trang ƒë·ªÉ hi·ªÉn th·ªã thay ƒë·ªïi
            const modal = bootstrap.Modal.getInstance(document.getElementById('editPostModal'));
            modal.hide();
            
            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            showEditSuccess();
            
            // Reload posts
            refreshPostFeed();
        }
    }
}

function showEditSuccess() {
    // T·∫°o ph·∫ßn t·ª≠ th√¥ng b√°o n·∫øu ch∆∞a t·ªìn t·∫°i
    let notification = document.querySelector('.edit-success');
    if (!notification) {
        notification = document.createElement('div');
        notification.className = 'edit-success';
        notification.innerHTML = '<i class="fas fa-check-circle me-2"></i>B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t';
        document.body.appendChild(notification);
    }
    
    // Hi·ªÉn th·ªã th√¥ng b√°o
    notification.style.display = 'block';
    
    // ·∫®n th√¥ng b√°o sau 3 gi√¢y
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

function showDeleteSuccess() {
    // T·∫°o ph·∫ßn t·ª≠ th√¥ng b√°o n·∫øu ch∆∞a t·ªìn t·∫°i
    let notification = document.querySelector('.delete-success');
    if (!notification) {
        notification = document.createElement('div');
        notification.className = 'delete-success';
        notification.innerHTML = '<i class="fas fa-trash me-2"></i>B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c x√≥a';
        document.body.appendChild(notification);
    }
    
    // Hi·ªÉn th·ªã th√¥ng b√°o
    notification.style.display = 'block';
    
    // ·∫®n th√¥ng b√°o sau 3 gi√¢y
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

async function deletePost(postId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y?')) {
        try {
            const response = await fetch(`http://127.0.0.1:8000/forum/posts/${postId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error('Kh√¥ng th·ªÉ x√≥a b√†i vi·∫øt');
            }
            
            // N·∫øu post ƒë√£ ƒë∆∞·ª£c th√≠ch, x√≥a kh·ªèi danh s√°ch liked posts
            if (likedPosts.has(parseInt(postId))) {
                likedPosts.delete(parseInt(postId));
                saveLikedPosts();
            }
            
            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            showDeleteSuccess();
            
            // Reload posts
            refreshPostFeed();
        } catch (error) {
            console.error('L·ªói khi x√≥a b√†i vi·∫øt:', error);
            alert('Kh√¥ng th·ªÉ x√≥a b√†i vi·∫øt. Vui l√≤ng th·ª≠ l·∫°i sau.');
        }
    }
}

function refreshPostFeed() {
    // X√≥a t·∫•t c·∫£ posts hi·ªán t·∫°i
    const container = document.getElementById('posts-container');
    container.innerHTML = '';
    
    // Load l·∫°i posts
    loadPosts();
}

// Preview media khi ch·ªçn file trong edit modal
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('edit-post-media')) {
        document.getElementById('edit-post-media').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('edit-preview-image').src = e.target.result;
                    document.getElementById('edit-media-preview').classList.remove('d-none');
                }
                reader.readAsDataURL(file);
            }
        });
    }
});

async function reportPost(postId) {
    try {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën b√°o c√°o b√†i vi·∫øt n√†y kh√¥ng?')) {
            const response = await fetch(`/forum/report-post/${postId}`, {
                method: 'POST'
            });
            
            if (!response.ok) {
                throw new Error('Kh√¥ng th·ªÉ b√°o c√°o b√†i vi·∫øt');
            }
            
            const data = await response.json();
            
            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            showReportSuccess();
        }
    } catch (error) {
        console.error('L·ªói khi b√°o c√°o b√†i vi·∫øt:', error);
        alert('Kh√¥ng th·ªÉ b√°o c√°o b√†i vi·∫øt. Vui l√≤ng th·ª≠ l·∫°i sau.');
    }
}

function showReportSuccess() {
    // T·∫°o ph·∫ßn t·ª≠ th√¥ng b√°o n·∫øu ch∆∞a t·ªìn t·∫°i
    let notification = document.querySelector('.report-success');
    if (!notification) {
        notification = document.createElement('div');
        notification.className = 'report-success';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(38, 38, 38, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 1050;
        `;
        notification.innerHTML = '<i class="fas fa-flag me-2"></i>C·∫£m ∆°n b·∫°n ƒë√£ b√°o c√°o b√†i vi·∫øt n√†y. Ch√∫ng t√¥i s·∫Ω xem x√©t v√† x·ª≠ l√Ω s·ªõm nh·∫•t c√≥ th·ªÉ.';
        document.body.appendChild(notification);
    }
    
    // Hi·ªÉn th·ªã th√¥ng b√°o
    notification.style.display = 'block';
    
    // ·∫®n th√¥ng b√°o sau 3 gi√¢y
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// Preview media khi ch·ªçn file
document.getElementById('post-media').addEventListener('change', previewMedia);

// Preview media khi ch·ªçn file trong edit modal
document.addEventListener('DOMContentLoaded', function() {
    // Kh·ªüi t·∫°o ng∆∞·ªùi d√πng hi·ªán t·∫°i
    initCurrentUser();
    
    // Load posts
    loadPosts();
    
    // Th√™m c√°c event listeners
    if (document.getElementById('post-media')) {
        document.getElementById('post-media').addEventListener('change', previewMedia);
    }
    
    if (document.getElementById('edit-post-media')) {
        document.getElementById('edit-post-media').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('edit-preview-image').src = e.target.result;
                    document.getElementById('edit-media-preview').classList.remove('d-none');
                }
                reader.readAsDataURL(file);
            }
        });
    }
});
    </script>
{% endblock %}
